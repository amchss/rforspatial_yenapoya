{
  "hash": "a06dc7f8ef01b62044ccd113883527b6",
  "result": {
    "engine": "knitr",
    "markdown": "---\nembed-resources: true\n---\n\n\n\n\n# Spatial Analysis\n\n## Spatial Clustering\n\n### Example: Spatial Clustering of Malnutrition in India\n\nThe steps involved in the clustering analysis are as follows:\n\n-   Filtering the malnutrition data for the stunting indicator.\n\n-   Joining the stunting data with the spatial data for India districts.\n\n-   Creating spatial weights to measure spatial relationships between districts.\n\n-   Computing Local Moran's I statistics to identify spatial clustering patterns.\n\n-   Assigning colors to different types of clustering patterns.\n\n-   Creating cluster labels and categorizing the clusters.\n\n-   Adding the clustering information to the spatial data.\n\n-   Plotting the districts colored by the identified clustering patterns.\n\n#### Load required libraries {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)   # For data manipulation and visualization\nlibrary(sf)          # For handling spatial data\nlibrary(here)        # For managing file paths\nlibrary(patchwork)   # For organizing multiple plots\nlibrary(rgeoda)      # LISA Statistics\nlibrary(spdep)       # Global Moran's Statistics\n\nsf_use_s2(FALSE)\n```\n:::\n\n\n\n\n#### Load the malnutrition data {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalnutrition_df <- read_csv(here(\"data\", \"malnutrition_districts_nfhs.csv\"))\n```\n:::\n\n\n\n\n#### Load the India district shapefile {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindia_district_sf <- read_rds(here(\"data\",\"india_district_sf.rds\"))\n```\n:::\n\n\n\n\n#### Explore the malnutrition data {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalnutrition_df |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 2,904\nColumns: 6\n$ state           <chr> \"Andaman & Nicobar Islands\", \"Andaman & Nicobar Island…\n$ district        <chr> \"Nicobar\", \"Nicobar\", \"Nicobar\", \"Nicobar\", \"North & M…\n$ district_unique <chr> \"nicobar_andaman_nicobar_islands\", \"nicobar_andaman_ni…\n$ indicator       <chr> \"stunting\", \"wasting\", \"underweight\", \"overweight\", \"s…\n$ nfhs4           <dbl> 20.3, 2.3, 10.5, 4.8, 32.5, 18.5, 33.5, 2.1, 20.1, 4.0…\n$ nfhs5           <dbl> 21.6, 7.8, 24.6, 1.5, 27.0, 8.3, 42.8, 0.8, 21.1, 3.5,…\n```\n\n\n:::\n:::\n\n\n\n\n#### Explore the India district shapefile {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindia_district_sf |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 726\nColumns: 2\n$ district_unique <chr> \"adilabad_telangana\", \"agar_malwa_madhya_pradesh\", \"ag…\n$ geometry        <MULTIPOLYGON [°]> MULTIPOLYGON (((78.84098 19..., MULTIPOLY…\n```\n\n\n:::\n:::\n\n\n\n\n#### Plot the India districts {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindia_district_sf |> \n  ggplot() +\n  geom_sf()\n```\n\n::: {.cell-output-display}\n![](spatial_analysis_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n## Clustering of districts with high proportions of stunting (NFHS-4)\n\n### GLOBAL CLUSTERING\n\nLet us check for global clustering using `spdep` package\n\n**Filter data for stunting indicator**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstunting_df <- malnutrition_df |> \n  filter(indicator == \"stunting\")\n```\n:::\n\n\n\n\n**Join spatial data with stunting data**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstunting_sf <- india_district_sf |> \n  left_join(stunting_df)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(district_unique)`\n```\n\n\n:::\n:::\n\n\n\n\n##### STEP ONE: Define neighboring polygons {.unnumbered}\n\n###### Define the neighbors using the Queen contiguity criterion {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnb <- poly2nb(stunting_sf, queen=TRUE)\n```\n:::\n\n\n\n\n##### STEP TWO: Assign weights to the neighbors {.unnumbered}\n\n###### Create a weights list with a binary (0/1) weight scheme {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlw <- nb2listw(nb, style=\"W\", zero.policy=TRUE)\n```\n:::\n\n\n\n\n##### STEP THREE: Compute the (weighted) neighbor mean values {.unnumbered}\n\n###### Estimate the spatial lag for each district {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstunting_sf <- stunting_sf |> \n  mutate(spatial_lag = lag.listw(lw, stunting_sf$nfhs4))\n```\n:::\n\n\n\n\n##### STEP FOUR: Plot Moran's Scatter Plot {.unnumbered}\n\n###### Moran's Scatter Plot shows the relationship between stunting and its spatial lag {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstunting_sf |> \n  ggplot(aes(x = nfhs4, y = spatial_lag)) +\n  geom_point() +\n  geom_smooth(method = \"lm\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](spatial_analysis_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n\n```{.r .cell-code}\nspdep::moran.plot(stunting_sf$nfhs4, lw)\n```\n\n::: {.cell-output-display}\n![](spatial_analysis_files/figure-html/unnamed-chunk-12-2.png){width=672}\n:::\n:::\n\n\n\n\n##### OLS Regression to estimate the slope of the Moran's Scatter Plot {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nols_model <- lm(spatial_lag ~ nfhs4, data = stunting_sf)\ncoef(ols_model)[2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    nfhs4 \n0.7046616 \n```\n\n\n:::\n:::\n\n\n\n\n##### STEP FIVE: Compute the Moran’s I statistic {.unnumbered}\n\n###### Moran's I statistic measures spatial autocorrelation {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmoran(stunting_sf$nfhs4, lw, length(nb), Szero(lw))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$I\n[1] 0.6848853\n\n$K\n[1] 2.443471\n```\n\n\n:::\n:::\n\n\n\n\n##### STEP SIX: Perform a Hypothesis Test {.unnumbered}\n\n###### Test the hypothesis that stunting is randomly distributed across districts {.unnumbered}\n\n###### 6a: ANALYTICAL Method {.unnumbered}\n\n###### Perform Moran's I test using the analytical method {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmoran.test(stunting_sf$nfhs4, lw, alternative=\"greater\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tMoran I test under randomisation\n\ndata:  stunting_sf$nfhs4  \nweights: lw  \nn reduced by no-neighbour observations  \n\nMoran I statistic standard deviate = 29.494, p-value < 2.2e-16\nalternative hypothesis: greater\nsample estimates:\nMoran I statistic       Expectation          Variance \n     0.6811118323     -0.0013869626      0.0005354613 \n```\n\n\n:::\n:::\n\n\n\n\n###### 6b: MONTE CARLO Method {.unnumbered}\n\nRun Monte Carlo simulation to test Moran's I statistic\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nmc_moran <- moran.mc(stunting_sf$nfhs4, lw, nsim=9999, alternative=\"greater\")\n```\n:::\n\n\n\n\n###### 6c: Plot the results {.unnumbered}\n\nPlot the null distribution of Moran's I values\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(mc_moran)\n```\n\n::: {.cell-output-display}\n![](spatial_analysis_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\nInterpretation: The observed statistic (0.68111) is significantly higher than expected, indicating clustering.\n\n###### 6d: Display the resulting statistics {.unnumbered}\n\nPrint the results of the Monte Carlo simulation\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc_moran\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tMonte-Carlo simulation of Moran I\n\ndata:  stunting_sf$nfhs4 \nweights: lw  \nnumber of simulations + 1: 10000 \n\nstatistic = 0.68111, observed rank = 10000, p-value = 1e-04\nalternative hypothesis: greater\n```\n\n\n:::\n:::\n\n\n\n\n### LOCAL CLUSTERING\n\n##### Load necessary libraries for local clustering {.unnumbered}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rgeoda)  # For local spatial analysis\n```\n:::\n\n\n\n\n##### STEP ONE: Create Spatial Weights {.unnumbered}\n\nCreate a spatial weights object using Queen contiguity\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqueen_w <- queen_weights(stunting_sf)\n```\n:::\n\n\n\n\n##### STEP TWO: Perform Local Moran's I Analysis {.unnumbered}\n\nCompute Local Moran's I statistics for stunting data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa <- local_moran(queen_w, stunting_sf[\"nfhs4\"])\n```\n:::\n\n\n\n\nDefine color schemes for visualization based on Local Moran's I results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa_colors <- lisa_colors(lisa)\n```\n:::\n\n\n\n\nDefine labels and clusters from Local Moran's I results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa_labels <- lisa_labels(lisa)\nlisa_clusters <- lisa_clusters(lisa)\nlisa_pvals <- lisa_pvalues(lisa)\nlisa_vals <- lisa_values(lisa)\n```\n:::\n\n\n\n\nCreate factor labels for clustering based on Local Moran's I results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa_labs <- factor(lisa_clusters, levels = 0:(length(lisa$labels)-1), labels = lisa$labels)\n```\n:::\n\n\n\n\nAdd Local Moran's I results to the spatial data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclustering_sf <- stunting_sf |>  bind_cols(lisa_clusters = lisa_clusters, \n                                           lisa_labs = lisa_labs, \n                                           lisa_pvals = lisa_pvals,\n                                           lisa_vals = lisa_vals)\n```\n:::\n\n\n\n\n##### STEP THREE: Categorize P-values {.unnumbered}\n\nCategorize p-values for plotting significance\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclustering_sf <- clustering_sf |> \n  mutate(lisa_pvals_cat = case_when(\n    lisa_pvals <= 0.001 ~ \"p <= 0.001\",\n    lisa_pvals <= 0.01 ~ \"p <= 0.01\",\n    lisa_pvals <= 0.05 ~ \"p <= 0.05\",\n    TRUE ~ \"Not Significant\",\n    is.na(lisa_pvals) ~ NA_character_\n  ))\n```\n:::\n\n\n\n\nDefine colors for p-value categories\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npval_colors <- c(\"#eeeeee\", \"#1b7837\", \"#a6dba0\", \"#d9f0d3\")\n```\n:::\n\n\n\n\n##### STEP FOUR: Create Plots {.unnumbered}\n\nCreate plot showing local clustering results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_hs <- clustering_sf  |>  \n  ggplot() +\n  geom_sf(aes(fill = lisa_labs), lwd=0.2) +\n  scale_fill_manual(name = \"Clustering\", values = lisa_colors) +\n  theme_bw()\n```\n:::\n\n\n\n\nCreate plot showing p-value categories\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_pval <- clustering_sf  |>  \n  ggplot() +\n  geom_sf(aes(fill = lisa_pvals_cat), lwd=0.2) +\n  scale_fill_manual(name = \"Local Moran's P Value\", values = pval_colors) +\n  theme_bw()\n```\n:::\n\n\n\n\n##### STEP FIVE: Combine the Plots {.unnumbered}\n\nCombine the two plots into one figure for comparison\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_stunting <- (p_hs + p_pval) + \n  plot_layout(ncol = 2, guides = \"collect\") +\n  plot_annotation(title = \"Spatial Clustering of Stunting (%) among Under-5 Children in India\",\n                  caption = \"Data Source: National Family Health Survey (NFHS) \\nhttps://rchiips.org/nfhs/\",\n                  theme = theme(plot.title = element_text(hjust = 0.5, size = 20)))\n```\n:::\n\n\n\n\nDisplay the combined plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_stunting\n```\n:::\n\n\n\n\n![](images/clustering_stunting_plot.png){fig-align=\"center\"}\n\nSave the final plot to a file\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(here(\"plots\", \"clustering_stunting_plot.png\"), width = 9, height = 6)\n```\n:::\n\n\n\n\n#### Exercise {.unnumbered}\n\nCan you try it for the rest of the indicators?\n\n",
    "supporting": [
      "spatial_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}